{% extends "base.html" %}

{% block content %}
<div class="d-flex">
    <div class="sidebar" style="width: 250px; background: #f8f9fa; padding: 15px; height: 100vh; border-right: 1px solid #dee2e6;">
        <h4>Monitor</h4>
        <ul id="main-tabs" class="nav flex-column">
            <li class="nav-item">
                <a class="nav-link active" href="#" onclick="showTab('spreads', this)">Cross-Platform Spreads</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" onclick="showTab('triangular', this)">Triangular Arbitrage</a>
            </li>
        </ul>
    </div>
    <div class="content flex-grow-1 p-4">
        <div id="spreads" class="tab-content active">
            </div>
        <div id="triangular" class="tab-content">
            </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<script>
        // Tab switching logic
        function showTab(tabId, element) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            document.querySelectorAll('#main-tabs li').forEach(li => li.classList.remove('active'));
            element.classList.add('active');
        }

        function showInnerTab(contentId, tabId, element) {
            document.querySelectorAll(`#${contentId} .inner-tab-content`).forEach(tab => tab.classList.remove('active'));
            document.getElementById(`${contentId}-${tabId}`).classList.add('active');
            document.querySelectorAll(`#${contentId}-inner-tabs div`).forEach(div => div.classList.remove('active'));
            element.classList.add('active');
        }

        const chartInstances = {};

        // 【FIXED】Function to create charts with multiple datasets for spreads
        function createSpreadChart(canvasId) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            chartInstances[canvasId] = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [
                        { label: 'Binance vs HTX', data: [], borderColor: 'rgb(255, 99, 132)', tension: 0.1 },
                        { label: 'Binance vs OKX', data: [], borderColor: 'rgb(54, 162, 235)', tension: 0.1 },
                        { label: 'HTX vs OKX', data: [], borderColor: 'rgb(75, 192, 192)', tension: 0.1 }
                    ]
                },
                options: {
                    scales: { x: { type: 'time', time: { unit: 'second' } }, y: { title: { display: true, text: 'Spread %' } } },
                    maintainAspectRatio: false
                }
            });
        }

        // 【FIXED】Function to create single-dataset charts
        function createArbitrageChart(canvasId, label) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            chartInstances[canvasId] = new Chart(ctx, {
                type: 'line',
                data: { datasets: [{ label: label, data: [], borderColor: 'rgb(153, 102, 255)', tension: 0.1 }] },
                options: {
                    scales: { x: { type: 'time', time: { unit: 'second' } }, y: { title: { display: true, text: 'Profit %' } } },
                    maintainAspectRatio: false
                }
            });
        }

        // Initialize all charts
        ['btcusdt', 'ethusdt', 'solusdt'].forEach(pair => createSpreadChart(`${pair}Chart`));
        ['usdt-btc-eth-usdt', 'usdt-sol-btc-usdt', 'usdt-sol-eth-usdt'].forEach(path => createArbitrageChart(`${path}-Chart`, 'Profit %'));

        function addData(chart, datasetIndex, dataPoint) {
            const dataset = chart.data.datasets[datasetIndex];
            if(dataset){
                dataset.data.push(dataPoint);
                if (dataset.data.length > 100) {
                    dataset.data.shift();
                }
            }
        }

        // WebSocket for Spreads
        const spreadSocket = new WebSocket('ws://' + window.location.host + '/ws/price_spread/');
        spreadSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            const pairLower = data.pair.toLowerCase();
            const chart = chartInstances[`${pairLower}Chart`];

            if (chart && data.spreads) {
                const timestamp = data.timestamp * 1000;

                // 【FIXED】 Map backend keys to chart dataset indices
                const spreadMapping = {
                    'binance_vs_htx': 0,
                    'binance_vs_okx': 1,
                    'htx_vs_okx': 2
                };

                for (const key in spreadMapping) {
                    if (data.spreads[key]) {
                        const spreadValue = parseFloat(data.spreads[key].spread_percentage);
                        addData(chart, spreadMapping[key], { x: timestamp, y: spreadValue });
                    }
                }
                chart.update('none'); // Update chart after adding all new data points

                const pricesDiv = document.getElementById(`prices-${pairLower}`);
                let pricesHtml = '';
                for (const [exchange, price] of Object.entries(data.prices)) {
                    pricesHtml += `<span>${exchange.toUpperCase()}: ${parseFloat(price).toFixed(4)}</span> | `;
                }
                pricesDiv.innerHTML = pricesHtml;
            }
        };

        // WebSocket for Triangular Arbitrage
        const triangularSocket = new WebSocket('ws://' + window.location.host + '/ws/triangular_arbitrage/');
        triangularSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            const pathId = data.path.toLowerCase();
            const chart = chartInstances[`${pathId}-Chart`];
            if (chart) {
                const dataset = chart.data.datasets[0];
                dataset.data.push({ x: data.timestamp * 1000, y: parseFloat(data.profit_percentage) });
                 if (dataset.data.length > 100) {
                    dataset.data.shift();
                }
                chart.update('none');
            }
        };

        spreadSocket.onclose = () => console.error('Spread socket closed unexpectedly');
        triangularSocket.onclose = () => console.error('Triangular arbitrage socket closed unexpectedly');
</script>
{% endblock %}